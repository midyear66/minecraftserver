{% extends "base.html" %}

{% block title %}Dashboard - MC Server Manager{% endblock %}

{% block content %}
<h1>Server Dashboard</h1>

<div class="card">
    <h2>Servers</h2>

    {% if servers %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Port</th>
                <th>Type</th>
                <th>Version</th>
                <th>Memory</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for server in servers %}
            <tr data-port="{{ server.external_port }}">
                <td class="server-name" style="cursor: pointer;">{{ server.name }}</td>
                <td>{{ server.external_port }}</td>
                <td>{{ server.type }}</td>
                <td>{{ server.version }}</td>
                <td>{{ server.memory }}</td>
                <td class="status-cell">
                    {% if server.running %}
                    <span class="status-badge status-running">Running</span>
                    {% else %}
                    <span class="status-badge status-stopped">Stopped</span>
                    {% endif %}
                </td>
                <td class="actions">
                    <form method="POST" action="{{ url_for('stop_server', port=server.external_port) }}" class="inline-form action-stop" {% if not server.running %}style="display:none"{% endif %}>
                        <button type="submit" class="btn btn-danger btn-sm">Stop</button>
                    </form>
                    <form method="POST" action="{{ url_for('start_server', port=server.external_port) }}" class="inline-form action-start" {% if server.running %}style="display:none"{% endif %}>
                        <button type="submit" class="btn btn-success btn-sm">Start</button>
                    </form>
                    <a href="{{ url_for('edit_server', port=server.external_port) }}" class="btn btn-secondary btn-sm">Edit</a>
                    <a href="{{ url_for('console', port=server.external_port) }}" class="btn btn-secondary btn-sm action-console" {% if not server.running %}style="opacity: 0.5; pointer-events: none;"{% endif %}>Console</a>
                    <a href="{{ url_for('players', port=server.external_port) }}" class="btn btn-secondary btn-sm">Players</a>
                    <a href="{{ url_for('backups', port=server.external_port) }}" class="btn btn-secondary btn-sm">Backups</a>
                    <form method="POST" action="{{ url_for('remove_server', port=server.external_port) }}" class="inline-form" onsubmit="return confirm('Remove server &quot;{{ server.name }}&quot;? Container will be deleted but data is preserved.')">
                        <button type="submit" class="btn btn-secondary btn-sm">Remove</button>
                    </form>
                </td>
            </tr>
            <tr class="detail-row" data-detail-port="{{ server.external_port }}" style="display: none;">
                <td colspan="7">
                    <div class="server-detail">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Players</span>
                                <span class="detail-value players-count">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Uptime</span>
                                <span class="detail-value uptime">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Auto-Shutdown</span>
                                <span class="detail-value shutdown-timer">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">MOTD</span>
                                <span class="detail-value motd">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Game Mode</span>
                                <span class="detail-value mode">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Difficulty</span>
                                <span class="detail-value difficulty">-</span>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #888;">No servers configured. Create one below.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Create Server</h2>
    <form method="POST" action="{{ url_for('create_server') }}" class="add-form">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" placeholder="Survival" required>
        </div>
        <div class="form-group">
            <label for="port">Port</label>
            <input type="number" id="port" name="port" placeholder="25565" required min="1" max="65535">
        </div>
        <div class="form-group">
            <label for="type">Type</label>
            <select id="type" name="type">
                {% for t in server_types %}
                <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="version">Version</label>
            <select id="version" name="version">
                <option value="LATEST" selected>LATEST</option>
            </select>
        </div>
        <div class="form-group">
            <label for="memory">Memory</label>
            <select id="memory" name="memory">
                <option value="1G">1G</option>
                <option value="2G" selected>2G</option>
                <option value="3G">3G</option>
                <option value="4G">4G</option>
                <option value="6G">6G</option>
                <option value="8G">8G</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Create Server</button>
    </form>
    <p style="color: #888; font-size: 0.85rem; margin-top: 1rem;">
        Remember to forward the server port (TCP) on your router for external access.
    </p>
</div>

<style>
    .server-name:hover {
        color: #e94560;
    }

    .detail-row td {
        padding-top: 0;
        border-top: none;
    }

    .server-detail {
        padding: 0.75rem 0;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-label {
        color: #888;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .detail-value {
        color: #eee;
        font-size: 0.95rem;
    }

    @media (max-width: 600px) {
        .detail-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function formatUptime(startedAt) {
        if (!startedAt) return '-';
        const start = new Date(startedAt);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        if (diff < 0) return '-';
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        if (h > 0) return h + 'h ' + m + 'm';
        return m + 'm';
    }

    function formatShutdown(seconds) {
        if (seconds === null || seconds === undefined) return '-';
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return m + 'm ' + s + 's';
    }

    function capitalize(str) {
        if (!str) return '-';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(servers => {
                servers.forEach(server => {
                    const row = document.querySelector(`tr[data-port="${server.external_port}"]`);
                    if (!row) return;

                    // Update status badge
                    const statusCell = row.querySelector('.status-cell');
                    if (server.running) {
                        statusCell.innerHTML = '<span class="status-badge status-running">Running</span>';
                    } else {
                        statusCell.innerHTML = '<span class="status-badge status-stopped">Stopped</span>';
                    }

                    // Update action buttons
                    const stopForm = row.querySelector('.action-stop');
                    const startForm = row.querySelector('.action-start');
                    if (stopForm && startForm) {
                        stopForm.style.display = server.running ? '' : 'none';
                        startForm.style.display = server.running ? 'none' : '';
                    }

                    // Update console button
                    const consoleBtn = row.querySelector('.action-console');
                    if (consoleBtn) {
                        consoleBtn.style.opacity = server.running ? '' : '0.5';
                        consoleBtn.style.pointerEvents = server.running ? '' : 'none';
                    }

                    // Update detail row
                    const detail = document.querySelector(`tr[data-detail-port="${server.external_port}"]`);
                    if (detail) {
                        detail.querySelector('.players-count').textContent =
                            server.running ? server.players + ' / ' + server.max_players : '-';
                        detail.querySelector('.uptime').textContent =
                            server.running ? formatUptime(server.started_at) : '-';
                        detail.querySelector('.shutdown-timer').textContent =
                            (server.shutdown_seconds !== null && server.shutdown_seconds !== undefined && server.running)
                                ? formatShutdown(server.shutdown_seconds)
                                : (server.running ? 'Players connected' : '-');
                        detail.querySelector('.motd').textContent = server.motd || '-';
                        detail.querySelector('.mode').textContent = capitalize(server.mode);
                        detail.querySelector('.difficulty').textContent = capitalize(server.difficulty);
                    }
                });
            })
            .catch(err => console.error('Status update failed:', err));
    }

    // Toggle detail rows on server name click
    document.querySelectorAll('.server-name').forEach(function(el) {
        el.addEventListener('click', function() {
            const port = this.closest('tr').dataset.port;
            const detailRow = document.querySelector('tr[data-detail-port="' + port + '"]');
            if (detailRow) {
                detailRow.style.display = detailRow.style.display === 'none' ? '' : 'none';
            }
        });
    });

    // Poll every 5 seconds
    setInterval(updateStatus, 5000);
    // Initial fetch to populate detail rows immediately
    updateStatus();

    // Version dropdown logic
    const typeSelect = document.getElementById('type');
    const versionSelect = document.getElementById('version');

    function loadVersions(serverType, selectedVersion) {
        versionSelect.disabled = true;
        versionSelect.innerHTML = '<option value="LATEST">Loading...</option>';

        fetch('/api/versions/' + serverType)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch versions');
                return response.json();
            })
            .then(data => {
                versionSelect.innerHTML = '';
                data.versions.forEach(function(ver) {
                    const option = document.createElement('option');
                    option.value = ver;
                    option.textContent = ver;
                    if (ver === selectedVersion) {
                        option.selected = true;
                    }
                    versionSelect.appendChild(option);
                });
                versionSelect.disabled = false;
            })
            .catch(function(err) {
                console.error('Version fetch error:', err);
                versionSelect.innerHTML = '<option value="LATEST" selected>LATEST</option>';
                versionSelect.disabled = false;
            });
    }

    if (typeSelect && versionSelect) {
        loadVersions(typeSelect.value, 'LATEST');
        typeSelect.addEventListener('change', function() {
            loadVersions(this.value, 'LATEST');
        });
    }
</script>
{% endblock %}
