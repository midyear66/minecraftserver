{% extends "base.html" %}

{% block title %}Dashboard - MC Server Manager{% endblock %}

{% block content %}
<h1>Server Dashboard</h1>

<div class="card">
    <h2>Servers</h2>

    {% if servers %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Port</th>
                <th>Type</th>
                <th>Version</th>
                <th>Memory</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for server in servers %}
            <tr data-port="{{ server.external_port }}">
                <td class="server-name" style="cursor: pointer;"><span class="expand-chevron">â€º</span> {{ server.name }}</td>
                <td>{{ server.external_port }}</td>
                <td>{{ server.type }}</td>
                <td>{{ server.version }}</td>
                <td>{{ server.memory }}</td>
                <td class="status-cell">
                    {% if server.running %}
                    <span class="status-badge status-running">Running</span>
                    {% else %}
                    <span class="status-badge status-stopped">Stopped</span>
                    {% endif %}
                </td>
                <td class="actions">
                    <form method="POST" action="{{ url_for('stop_server', port=server.external_port) }}" class="inline-form action-stop" {% if not server.running %}style="display:none"{% endif %}>
                        <button type="submit" class="btn btn-danger btn-sm">Stop</button>
                    </form>
                    <form method="POST" action="{{ url_for('start_server', port=server.external_port) }}" class="inline-form action-start" {% if server.running %}style="display:none"{% endif %}>
                        <button type="submit" class="btn btn-success btn-sm">Start</button>
                    </form>
                    <a href="{{ url_for('edit_server', port=server.external_port) }}" class="btn btn-secondary btn-sm">Edit</a>
                    <a href="{{ url_for('console', port=server.external_port) }}" class="btn btn-secondary btn-sm action-console" {% if not server.running %}style="opacity: 0.5; pointer-events: none;"{% endif %}>Console</a>
                    <a href="{{ url_for('players', port=server.external_port) }}" class="btn btn-secondary btn-sm">Players</a>
                    <a href="{{ url_for('backups', port=server.external_port) }}" class="btn btn-secondary btn-sm">Backups</a>
                    <form method="POST" action="{{ url_for('remove_server', port=server.external_port) }}" class="inline-form" onsubmit="return confirm('Remove server &quot;{{ server.name }}&quot;? Container will be deleted but data is preserved.')">
                        <button type="submit" class="btn btn-secondary btn-sm">Remove</button>
                    </form>
                    {% if server.get('bluemap_enabled') and server.get('bluemap_port') %}
                    {# Plugin mode (Paper/Spigot) requires server running; Standalone mode runs independently #}
                    {% set is_plugin_mode = server.type in ('PAPER', 'SPIGOT') %}
                    <a href="http://{{ request.host.split(':')[0] }}:{{ server.bluemap_port }}" target="_blank" class="btn btn-secondary btn-sm action-map" data-bluemap-mode="{{ 'plugin' if is_plugin_mode else 'standalone' }}" {% if is_plugin_mode and not server.running %}style="opacity: 0.5; pointer-events: none;"{% endif %}>Map</a>
                    {% endif %}
                    {% if server.type in ('PAPER', 'SPIGOT', 'FABRIC', 'FORGE') %}
                    <a href="{{ url_for('server_mods', port=server.external_port) }}" class="btn btn-secondary btn-sm">{{ 'Plugins' if server.type in ('PAPER', 'SPIGOT') else 'Mods' }}</a>
                    {% endif %}
                </td>
            </tr>
            <tr class="detail-row" data-detail-port="{{ server.external_port }}" style="display: none;">
                <td colspan="7">
                    <div class="server-detail">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Players</span>
                                <span class="detail-value players-count">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Uptime</span>
                                <span class="detail-value uptime">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Auto-Shutdown</span>
                                <span class="detail-value shutdown-timer">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">MOTD</span>
                                <span class="detail-value motd">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Game Mode</span>
                                <span class="detail-value mode">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Difficulty</span>
                                <span class="detail-value difficulty">-</span>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #888;">No servers configured. Create one below.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Create Server</h2>
    <form method="POST" action="{{ url_for('create_server') }}" class="add-form">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" placeholder="Survival" required>
        </div>
        <div class="form-group">
            <label for="port">Port</label>
            <input type="number" id="port" name="port" placeholder="25565" required min="1" max="65535">
        </div>
        <div class="form-group">
            <label for="type">Type</label>
            <select id="type" name="type">
                {% for t in server_types %}
                <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="version">Version</label>
            <select id="version" name="version">
                <option value="LATEST" selected>LATEST</option>
            </select>
        </div>
        <div class="form-group">
            <label for="memory">Memory</label>
            <select id="memory" name="memory">
                <option value="1G">1G</option>
                <option value="2G" selected>2G</option>
                <option value="3G">3G</option>
                <option value="4G">4G</option>
                <option value="6G">6G</option>
                <option value="8G">8G</option>
            </select>
        </div>
        <div class="form-group bluemap-option" id="bluemap-option" style="display: none;">
            <div class="checkbox-group">
                <input type="checkbox" id="bluemap_enabled" name="bluemap_enabled" value="1">
                <label for="bluemap_enabled" style="margin: 0;">Enable BlueMap (3D web map)</label>
            </div>
            <div class="checkbox-group" style="margin-top: 0.5rem; margin-left: 1.5rem;">
                <input type="checkbox" id="bluemap_caves" name="bluemap_caves" value="1">
                <label for="bluemap_caves" style="margin: 0;">Show Caves</label>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Server</button>
    </form>
    <p style="color: #888; font-size: 0.85rem; margin-top: 1rem;">
        Remember to forward the server port (TCP) on your router for external access.
    </p>
</div>

<div class="card">
    <h2>Import Server</h2>
    <form method="POST" action="{{ url_for('import_server') }}" enctype="multipart/form-data" class="add-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="import_name">Name</label>
                <input type="text" id="import_name" name="name" placeholder="Imported Server" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="import_port">Port</label>
                <input type="number" id="import_port" name="port" placeholder="25565" required min="1" max="65535">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="import_memory">Memory</label>
                <select id="import_memory" name="memory">
                    <option value="2G" selected>2G</option>
                    <option value="3G">3G</option>
                    <option value="4G">4G</option>
                    <option value="6G">6G</option>
                    <option value="8G">8G</option>
                </select>
            </div>
        </div>
        <div style="display: flex; align-items: stretch; gap: 0.75rem; margin-top: 0.75rem;">
            <div class="form-group" style="margin-bottom: 0; flex: 0 0 auto; display: flex; flex-direction: column;">
                <label for="import_type">Source</label>
                <select id="import_type" name="import_type" onchange="toggleImportType()" style="flex: 1;">
                    <option value="file">Upload Archive</option>
                    <option value="path">Local Path</option>
                </select>
            </div>
            <div class="form-group" id="file_input_group" style="margin-bottom: 0; flex: 1; display: flex; flex-direction: column;">
                <label for="server_file">Archive</label>
                <input type="file" id="server_file" name="server_file" accept=".zip,.tar.gz,.tgz,application/zip,application/gzip,application/x-gzip,application/x-tar,application/x-compressed-tar" style="flex: 1;">
            </div>
            <div class="form-group" id="path_input_group" style="display: none; margin-bottom: 0; flex: 1; flex-direction: column;">
                <label for="server_path">Path</label>
                <input type="text" id="server_path" name="server_path" placeholder="/path/to/server" style="flex: 1;">
            </div>
            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Import</button>
            <label style="font-weight: normal; cursor: pointer; margin: 0; white-space: nowrap; align-self: flex-end;">
                <input type="checkbox" name="auto_start" value="1" checked> Start after import
            </label>
        </div>
    </form>
</div>

<script>
function toggleImportType() {
    const importType = document.getElementById('import_type').value;
    const fileGroup = document.getElementById('file_input_group');
    const pathGroup = document.getElementById('path_input_group');
    const fileInput = document.getElementById('server_file');
    const pathInput = document.getElementById('server_path');

    if (importType === 'file') {
        fileGroup.style.display = 'flex';
        pathGroup.style.display = 'none';
        fileInput.required = true;
        pathInput.required = false;
    } else {
        fileGroup.style.display = 'none';
        pathGroup.style.display = 'flex';
        fileInput.required = false;
        pathInput.required = true;
    }
}
</script>

<style>
    .server-name:hover {
        color: #e94560;
    }

    .expand-chevron {
        display: inline-block;
        transition: transform 0.2s ease;
        font-weight: bold;
    }

    .expand-chevron.expanded {
        transform: rotate(90deg);
    }

    .detail-row td {
        padding-top: 0;
        border-top: none;
    }

    .server-detail {
        padding: 0.75rem 0;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-label {
        color: #888;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .detail-value {
        color: #eee;
        font-size: 0.95rem;
    }

    @media (max-width: 600px) {
        .detail-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function formatUptime(startedAt) {
        if (!startedAt) return '-';
        const start = new Date(startedAt);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        if (diff < 0) return '-';
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        if (h > 0) return h + 'h ' + m + 'm';
        return m + 'm';
    }

    function formatShutdown(seconds) {
        if (seconds === null || seconds === undefined) return '-';
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return m + 'm ' + s + 's';
    }

    function capitalize(str) {
        if (!str) return '-';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(servers => {
                servers.forEach(server => {
                    const row = document.querySelector(`tr[data-port="${server.external_port}"]`);
                    if (!row) return;

                    // Update status badge
                    const statusCell = row.querySelector('.status-cell');
                    if (server.running) {
                        statusCell.innerHTML = '<span class="status-badge status-running">Running</span>';
                    } else {
                        statusCell.innerHTML = '<span class="status-badge status-stopped">Stopped</span>';
                    }

                    // Update action buttons
                    const stopForm = row.querySelector('.action-stop');
                    const startForm = row.querySelector('.action-start');
                    if (stopForm && startForm) {
                        stopForm.style.display = server.running ? '' : 'none';
                        startForm.style.display = server.running ? 'none' : '';
                    }

                    // Update console button
                    const consoleBtn = row.querySelector('.action-console');
                    if (consoleBtn) {
                        consoleBtn.style.opacity = server.running ? '' : '0.5';
                        consoleBtn.style.pointerEvents = server.running ? '' : 'none';
                    }

                    // Update map button (only disable for plugin mode when server stopped)
                    const mapBtn = row.querySelector('.action-map');
                    if (mapBtn) {
                        const isPluginMode = mapBtn.dataset.bluemapMode === 'plugin';
                        const shouldDisable = isPluginMode && !server.running;
                        mapBtn.style.opacity = shouldDisable ? '0.5' : '';
                        mapBtn.style.pointerEvents = shouldDisable ? 'none' : '';
                    }

                    // Update detail row
                    const detail = document.querySelector(`tr[data-detail-port="${server.external_port}"]`);
                    if (detail) {
                        detail.querySelector('.players-count').textContent =
                            server.running ? server.players + ' / ' + server.max_players : '-';
                        detail.querySelector('.uptime').textContent =
                            server.running ? formatUptime(server.started_at) : '-';
                        // Determine auto-shutdown status
                        let shutdownText = '-';
                        if (server.running) {
                            if (server.manual_start) {
                                shutdownText = 'Disabled (manual)';
                            } else if (server.shutdown_seconds !== null && server.shutdown_seconds !== undefined) {
                                shutdownText = formatShutdown(server.shutdown_seconds);
                            } else {
                                shutdownText = 'Players connected';
                            }
                        }
                        detail.querySelector('.shutdown-timer').textContent = shutdownText;
                        detail.querySelector('.motd').textContent = server.motd || '-';
                        detail.querySelector('.mode').textContent = capitalize(server.mode);
                        detail.querySelector('.difficulty').textContent = capitalize(server.difficulty);
                    }
                });
            })
            .catch(err => console.error('Status update failed:', err));
    }

    // Toggle detail rows on server name click
    document.querySelectorAll('.server-name').forEach(function(el) {
        el.addEventListener('click', function() {
            const port = this.closest('tr').dataset.port;
            const detailRow = document.querySelector('tr[data-detail-port="' + port + '"]');
            const chevron = this.querySelector('.expand-chevron');
            if (detailRow) {
                const isHidden = detailRow.style.display === 'none';
                detailRow.style.display = isHidden ? '' : 'none';
                if (chevron) {
                    chevron.classList.toggle('expanded', isHidden);
                }
            }
        });
    });

    // Poll every 5 seconds
    setInterval(updateStatus, 5000);
    // Initial fetch to populate detail rows immediately
    updateStatus();

    // Version dropdown logic
    const typeSelect = document.getElementById('type');
    const versionSelect = document.getElementById('version');

    function loadVersions(serverType, selectedVersion) {
        versionSelect.disabled = true;
        versionSelect.innerHTML = '<option value="LATEST">Loading...</option>';

        fetch('/api/versions/' + serverType)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch versions');
                return response.json();
            })
            .then(data => {
                versionSelect.innerHTML = '';
                data.versions.forEach(function(ver) {
                    const option = document.createElement('option');
                    option.value = ver;
                    option.textContent = ver;
                    if (ver === selectedVersion) {
                        option.selected = true;
                    }
                    versionSelect.appendChild(option);
                });
                versionSelect.disabled = false;
            })
            .catch(function(err) {
                console.error('Version fetch error:', err);
                versionSelect.innerHTML = '<option value="LATEST" selected>LATEST</option>';
                versionSelect.disabled = false;
            });
    }

    if (typeSelect && versionSelect) {
        loadVersions(typeSelect.value, 'LATEST');
        typeSelect.addEventListener('change', function() {
            loadVersions(this.value, 'LATEST');
        });
    }

    // BlueMap option visibility (all server types supported)
    const bluemapOption = document.getElementById('bluemap-option');
    const bluemapSupportedTypes = ['PAPER', 'SPIGOT', 'VANILLA', 'FORGE', 'FABRIC'];

    function updateBluemapVisibility() {
        if (typeSelect && bluemapOption) {
            const supported = bluemapSupportedTypes.includes(typeSelect.value);
            bluemapOption.style.display = supported ? '' : 'none';
            // Update label to show mode
            const label = bluemapOption.querySelector('label');
            if (label) {
                const isPlugin = ['PAPER', 'SPIGOT'].includes(typeSelect.value);
                label.textContent = isPlugin
                    ? 'Enable BlueMap (3D web map - plugin)'
                    : 'Enable BlueMap (3D web map - standalone)';
            }
        }
    }

    if (typeSelect) {
        updateBluemapVisibility();
        typeSelect.addEventListener('change', updateBluemapVisibility);
    }
</script>
{% endblock %}
