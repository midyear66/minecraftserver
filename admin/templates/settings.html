{% extends "base.html" %}

{% block title %}Settings - MC Server Manager{% endblock %}

{% block content %}
<h1>Settings</h1>

<div class="card">
    <h2>Proxy Settings</h2>
    <form method="POST">
        <div class="form-group">
            <label for="timeout">Idle Timeout (minutes)</label>
            <input type="number" id="timeout" name="timeout" value="{{ config.timeout }}" min="1" max="60">
            <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">
                Time to wait before shutting down an empty server
            </p>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="auto_shutdown" name="auto_shutdown" {% if config.auto_shutdown %}checked{% endif %}>
                <label for="auto_shutdown" style="margin: 0;">Enable Auto Shutdown</label>
            </div>
            <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">
                Automatically stop servers when no players are connected
            </p>
        </div>

        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>
</div>

<h1>Notifications</h1>

<form method="POST" action="{{ url_for('notifications') }}">
    <div class="card">
        <h2>Email (SMTP)</h2>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="email_enabled" name="email_enabled"
                   {% if config.notifications.email.enabled %}checked{% endif %}>
            <label for="email_enabled" style="margin-bottom: 0;">Enable Email Notifications</label>
        </div>

        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label for="smtp_host">SMTP Host</label>
                <input type="text" id="smtp_host" name="smtp_host"
                       value="{{ config.notifications.email.smtp_host }}"
                       placeholder="smtp.example.com">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="smtp_port">Port</label>
                <input type="number" id="smtp_port" name="smtp_port"
                       value="{{ config.notifications.email.smtp_port }}">
            </div>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="smtp_tls" name="smtp_tls"
                   {% if config.notifications.email.smtp_tls %}checked{% endif %}>
            <label for="smtp_tls" style="margin-bottom: 0;">Use TLS</label>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="smtp_user">SMTP Username</label>
                <input type="text" id="smtp_user" name="smtp_user"
                       value="{{ config.notifications.email.smtp_user }}"
                       placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label for="smtp_password">SMTP Password</label>
                <input type="password" id="smtp_password" name="smtp_password"
                       placeholder="{% if config.notifications.email.smtp_password %}(unchanged){% else %}Enter password{% endif %}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="from_address">From Address</label>
                <input type="text" id="from_address" name="from_address"
                       value="{{ config.notifications.email.from_address }}"
                       placeholder="mc@example.com">
            </div>
            <div class="form-group">
                <label for="to_addresses">To Addresses (comma-separated)</label>
                <input type="text" id="to_addresses" name="to_addresses"
                       value="{{ config.notifications.email.to_addresses | join(', ') }}"
                       placeholder="admin@example.com, user@example.com">
            </div>
        </div>

        <div class="form-group">
            <label>Events</label>
            <div class="events-grid">
                <div class="checkbox-group">
                    <input type="checkbox" id="email_server_start" name="email_server_start"
                           {% if config.notifications.email.events.server_start %}checked{% endif %}>
                    <label for="email_server_start" style="margin-bottom: 0;">Server Start</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="email_server_stop" name="email_server_stop"
                           {% if config.notifications.email.events.server_stop %}checked{% endif %}>
                    <label for="email_server_stop" style="margin-bottom: 0;">Server Stop</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="email_player_join" name="email_player_join"
                           {% if config.notifications.email.events.player_join %}checked{% endif %}>
                    <label for="email_player_join" style="margin-bottom: 0;">Player Join</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="email_player_leave" name="email_player_leave"
                           {% if config.notifications.email.events.player_leave %}checked{% endif %}>
                    <label for="email_player_leave" style="margin-bottom: 0;">Player Leave</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="email_unauthorized_login" name="email_unauthorized_login"
                           {% if config.notifications.email.events.unauthorized_login %}checked{% endif %}>
                    <label for="email_unauthorized_login" style="margin-bottom: 0;">Unauthorized Login</label>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="testNotification('email')">Test Email</button>
    </div>

    <div class="card">
        <h2>Pushover</h2>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="pushover_enabled" name="pushover_enabled"
                   {% if config.notifications.pushover.enabled %}checked{% endif %}>
            <label for="pushover_enabled" style="margin-bottom: 0;">Enable Pushover Notifications</label>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="pushover_user_key">User Key</label>
                <input type="text" id="pushover_user_key" name="pushover_user_key"
                       value="{{ config.notifications.pushover.user_key }}"
                       placeholder="Your Pushover user key">
            </div>
            <div class="form-group">
                <label for="pushover_app_token">App Token</label>
                <input type="password" id="pushover_app_token" name="pushover_app_token"
                       placeholder="{% if config.notifications.pushover.app_token %}(unchanged){% else %}Your Pushover app token{% endif %}">
            </div>
        </div>

        <div class="form-group">
            <label for="pushover_priority">Priority</label>
            <select id="pushover_priority" name="pushover_priority">
                <option value="-2" {% if config.notifications.pushover.priority == -2 %}selected{% endif %}>Lowest</option>
                <option value="-1" {% if config.notifications.pushover.priority == -1 %}selected{% endif %}>Low</option>
                <option value="0" {% if config.notifications.pushover.priority == 0 %}selected{% endif %}>Normal</option>
                <option value="1" {% if config.notifications.pushover.priority == 1 %}selected{% endif %}>High</option>
            </select>
        </div>

        <div class="form-group">
            <label>Events</label>
            <div class="events-grid">
                <div class="checkbox-group">
                    <input type="checkbox" id="pushover_server_start" name="pushover_server_start"
                           {% if config.notifications.pushover.events.server_start %}checked{% endif %}>
                    <label for="pushover_server_start" style="margin-bottom: 0;">Server Start</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pushover_server_stop" name="pushover_server_stop"
                           {% if config.notifications.pushover.events.server_stop %}checked{% endif %}>
                    <label for="pushover_server_stop" style="margin-bottom: 0;">Server Stop</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pushover_player_join" name="pushover_player_join"
                           {% if config.notifications.pushover.events.player_join %}checked{% endif %}>
                    <label for="pushover_player_join" style="margin-bottom: 0;">Player Join</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pushover_player_leave" name="pushover_player_leave"
                           {% if config.notifications.pushover.events.player_leave %}checked{% endif %}>
                    <label for="pushover_player_leave" style="margin-bottom: 0;">Player Leave</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pushover_unauthorized_login" name="pushover_unauthorized_login"
                           {% if config.notifications.pushover.events.unauthorized_login %}checked{% endif %}>
                    <label for="pushover_unauthorized_login" style="margin-bottom: 0;">Unauthorized Login</label>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="testNotification('pushover')">Test Pushover</button>
    </div>

    <button type="submit" class="btn btn-primary">Save Notification Settings</button>
</form>

<div id="test-result" class="flash" style="display: none; margin-top: 1rem;"></div>

<div class="card">
    <h2>About</h2>
    <p style="color: #888;">
        MC Server Manager uses Docker containers (itzg/minecraft-server) for each Minecraft server.
        The proxy runs with host networking and can bind to any port without configuration changes.
    </p>
    <p style="color: #888; margin-top: 1rem;">
        Server data is stored in <code>mc_data/&lt;container_name&gt;/</code> and is preserved when servers are removed.
    </p>
</div>

<style>
    .events-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    @media (max-width: 600px) {
        .events-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
function testNotification(service) {
    const resultDiv = document.getElementById('test-result');
    resultDiv.style.display = 'block';
    resultDiv.className = 'flash';
    resultDiv.textContent = 'Testing...';

    fetch('/notifications/test/' + service, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.className = 'flash ' + (data.success ? 'success' : 'error');
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.className = 'flash error';
        resultDiv.textContent = 'Error: ' + error.message;
    });
}
</script>
{% endblock %}
